name: Mutation Testing CI

on: [push, pull_request]

jobs:
  mutation-test:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¦ Checkout repository
      uses: actions/checkout@v3

    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: âœ… Add BugsInPy CLI to PATH
      run: echo "$GITHUB_WORKSPACE/BugsInPy/framework/bin" >> $GITHUB_PATH

    - name: ðŸ Confirm Python version
      run: |
        python --version
        which python

    - name: ðŸ“¥ Install dependencies
      run: |
        pip install -r mutmut/requirements.txt || true
        pip install -e mutmut || true
        pip install python_toolbox
        pip install requests
        pip install PyYAML

    # - name: ðŸŒ Install Ollama CLI
    #   run: |
    #     curl -fsSL https://ollama.com/install.sh | sh
    #     echo "$HOME/.ollama/bin" >> $GITHUB_PATH
        
    # - name: ðŸ“¥ Pull CodeLlama-7b model
    #   run: ollama pull codellama:7b-instruct
    - name: ðŸ¤– Start Ollama using ai-action
      uses: ai-action/ollama-action@v1
      with:
        model: codellama:7b-instruct

    - name: ðŸ§ª Run diff-based mutation testing on keras bug
      run: |
        python run_bug_test.py

    - name: ðŸ“¤ Upload mutation results
      uses: actions/upload-artifact@v4
      with:
        name: mutation-results
        path: /tmp/bug-project/**/mutants/survived_mutants.json

    - name: ðŸ“¥ Move mutant file to expected location
      run: |
        mkdir -p mutants
        cp $(find /tmp/bug-project -name "survived_mutants.json" | head -n 1) mutants/
    - name: âœ… Verify Ollama is responding
      run: |
        curl -X POST http://localhost:11434 \
          -H "Content-Type: application/json" \
          -d '{"model": "codellama:7b-instruct", "messages": [{"role": "user", "content": "ping"}], "stream": false}'


    # - name: ðŸš€ Start Ollama HTTP API
    #   run: |
    #     # Launch Ollama in the background listening on 11434
    #     nohup ollama serve --listen 11434 >/dev/null 2>&1 &
    #     # Give it a few seconds to spin up
    #     sleep 5
    

    - name: ðŸ¤– Run Ollama mutant explainer
      run: |
        python generate_report.py

    - name: ðŸ“¤ Upload explained mutant file
      uses: actions/upload-artifact@v4
      with:
        name: mutant-explanations
        path: mutants/survived_mutants_with_explanations.json

